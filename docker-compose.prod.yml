# Production Docker Compose - Bourse ALPE
# Usage:
#   1. Copy .env.production.example to .env.production and fill in values
#   2. Build frontend: docker compose -f docker-compose.prod.yml build frontend
#   3. Initial SSL cert: see comments in certbot service below
#   4. Start: docker compose -f docker-compose.prod.yml up -d

services:
  # Database (MariaDB)
  db:
    image: mariadb:10.11
    container_name: bourse-db
    volumes:
      - db_data:/var/lib/mysql
      - ./docker/db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - alpe-network
    restart: unless-stopped

  # Backend API (FastAPI + Gunicorn)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    container_name: bourse-backend
    env_file:
      - .env.production
    environment:
      DATABASE_URL: mysql+aiomysql://${DB_USER}:${DB_PASSWORD}@db:3306/${DB_NAME}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - alpe-network
    restart: unless-stopped

  # Frontend (React build served by Nginx with SSL)
  nginx:
    image: nginx:alpine
    container_name: bourse-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.prod.conf:/etc/nginx/conf.d/default.conf:ro
      - frontend_build:/usr/share/nginx/html:ro
      - certbot_conf:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro
    depends_on:
      - backend
    networks:
      - alpe-network
    restart: unless-stopped

  # Frontend builder (builds React app into shared volume)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: build
    container_name: bourse-frontend-build
    volumes:
      - frontend_build:/output
    entrypoint: ["sh", "-c", "cp -r /app/dist/* /output/"]

  # SSL certificate management (Let's Encrypt)
  # Initial setup:
  #   docker compose -f docker-compose.prod.yml run --rm certbot \
  #     certonly --webroot -w /var/www/certbot \
  #     -d ${DOMAIN} --email ${ADMIN_EMAIL} --agree-tos --no-eff-email
  # Then restart nginx to pick up the new cert.
  certbot:
    image: certbot/certbot
    container_name: bourse-certbot
    volumes:
      - certbot_conf:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    restart: unless-stopped

networks:
  alpe-network:
    driver: bridge

volumes:
  db_data:
  frontend_build:
  certbot_conf:
  certbot_www:
